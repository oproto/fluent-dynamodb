# Design Document: Example Entity Cleanup

## Overview

This design addresses the cleanup of entity definitions across all example projects in the Oproto.FluentDynamoDb repository. The cleanup removes incorrect attribute combinations, redundant interface implementations, and duplicate key generation methods that conflict with source-generated code.

The changes are purely structural refactoring with no functional impact - the source generator already handles these concerns, so removing the redundant code will not change runtime behavior.

## Architecture

### Current State (Problematic)

```csharp
// INCORRECT: Combines multiple redundant elements
[DynamoDbEntity]                    // ❌ Not needed for table entities
[DynamoDbTable("Orders")]
public partial class Order : IDynamoDbEntity  // ❌ Auto-generated by source generator
{
    // ... properties ...
    
    // ❌ Duplicates source-generated key methods
    public static string CreatePk(string orderId) => $"ORDER#{orderId}";
    public static string CreateSk() => MetaSk;
}
```

### Target State (Correct)

```csharp
// CORRECT: Clean entity definition with key prefix configuration
[DynamoDbTable("Orders")]
public partial class Order
{
    // ✅ Use Prefix property to configure key formatting
    [PartitionKey(Prefix = "ORDER")]
    [DynamoDbAttribute("pk")]
    public string Pk { get; set; } = string.Empty;

    [SortKey]
    [DynamoDbAttribute("sk")]
    public string Sk { get; set; } = string.Empty;
    
    // ... other properties ...
}
```

With this configuration, the source generator produces:
- `Order.Keys.Pk(orderId)` → returns `"ORDER#" + orderId` (e.g., `"ORDER#12345"`)
- `Order.Keys.Sk(sk)` → returns the raw sk value
- `Order.Keys.Key(orderId, sk)` → returns both formatted keys as a tuple

### Key Attribute Configuration

The `[PartitionKey]` and `[SortKey]` attributes support key formatting:

| Property | Default | Description |
|----------|---------|-------------|
| `Prefix` | `null` | Optional prefix prepended to key values (e.g., `"ORDER"`, `"USER"`) |
| `Separator` | `"#"` | Separator between prefix and value (e.g., `"#"`, `"_"`, `":"`) |

**Example configurations:**
```csharp
// Generates: "ORDER#12345"
[PartitionKey(Prefix = "ORDER")]

// Generates: "USER_12345"  
[PartitionKey(Prefix = "USER", Separator = "_")]

// Generates: "12345" (no prefix)
[PartitionKey]
```

### Attribute Purpose Clarification

| Attribute | Purpose | When to Use |
|-----------|---------|-------------|
| `[DynamoDbTable]` | Marks a class as a DynamoDB table entity, triggers source generation | All top-level entities stored in DynamoDB |
| `[DynamoDbEntity]` | Marks a class for hydration support in nested map types | Only for nested objects used with `[DynamoDbMap]` |

## Components and Interfaces

### Affected Example Projects

1. **OperationSamples** (`examples/OperationSamples/Models/`)
   - `Order.cs` - Remove `[DynamoDbEntity]`, `CreatePk()`, `CreateSk()`; Add `Prefix = "ORDER"` to `[PartitionKey]`
   - `OrderLine.cs` - Remove `[DynamoDbEntity]`, `CreatePk()`, `CreateSk()`; Add `Prefix = "ORDER"` to `[PartitionKey]`, `Prefix = "LINE"` to `[SortKey]`

2. **InvoiceManager** (`examples/InvoiceManager/Entities/`)
   - `Customer.cs` - Remove `[DynamoDbEntity]`, `: IDynamoDbEntity`, `CreatePk()`
   - `Invoice.cs` - Remove `[DynamoDbEntity]`, `: IDynamoDbEntity`, `CreateSk()`, `CreateSkPrefix()`
   - `InvoiceLine.cs` - Remove `[DynamoDbEntity]`, `: IDynamoDbEntity`, `CreateSk()`

3. **StoreLocator** (`examples/StoreLocator/Entities/`)
   - `StoreGeoHash.cs` - Remove `[DynamoDbEntity]`, `: IDynamoDbEntity`
   - `StoreH3.cs` - Remove `[DynamoDbEntity]`, `: IDynamoDbEntity`
   - `StoreS2.cs` - Remove `[DynamoDbEntity]`, `: IDynamoDbEntity`

4. **TransactionDemo** (`examples/TransactionDemo/Entities/`)
   - `Account.cs` - Remove `[DynamoDbEntity]`, `: IDynamoDbEntity`, `CreatePk()`
   - `TransactionRecord.cs` - Remove `[DynamoDbEntity]`, `: IDynamoDbEntity`, `CreateSk()`

5. **TodoList** (`examples/TodoList/Entities/`)
   - `TodoItem.cs` - Remove `[DynamoDbEntity]`, `: IDynamoDbEntity`

### Affected Documentation Files

Based on grep search results, the following documentation files need review:

1. **`docs/DOCUMENTATION_CHANGELOG.md`** - Contains example with both attributes and `: IDynamoDbEntity`
2. **`docs/examples/ProjectionModelsExamples.md`** - Multiple `[DynamoDbEntity]` usages on table entities
3. **`docs/core-features/ProjectionModels.md`** - `[DynamoDbEntity]` on table entities
4. **`docs/advanced-topics/FieldLevelSecurity.md`** - `[DynamoDbEntity]` on table entities

Files that correctly use `[DynamoDbEntity]` for nested types only (no changes needed):
- `docs/reference/AdvancedTypesQuickReference.md` - Correctly shows nested map usage
- `docs/reference/AttributeReference.md` - Correctly documents nested type requirement
- `docs/examples/AdvancedTypesExamples.md` - Correctly shows nested Address type
- `docs/advanced-topics/AdvancedTypes.md` - Correctly documents nested type pattern
- `docs/QUICK_REFERENCE.md` - Correctly shows nested Address type

## Data Models

No data model changes - this is a code cleanup only.

## Correctness Properties

*A property is a characteristic or behavior that should hold true across all valid executions of a system-essentially, a formal statement about what the system should do. Properties serve as the bridge between human-readable specifications and machine-verifiable correctness guarantees.*

### Property 1: Example entity structural correctness

*For any* entity file in the example projects (OperationSamples, InvoiceManager, StoreLocator, TransactionDemo, TodoList), the entity class definition should satisfy all of the following:
- Should NOT have the `[DynamoDbEntity]` attribute
- Should NOT explicitly implement `: IDynamoDbEntity` interface
- Should NOT contain static methods named `CreatePk` or `CreateSk`

**Validates: Requirements 1.1, 1.2, 2.1, 3.1**

### Property 2: Documentation code block correctness

*For any* code block in documentation files that shows an entity class definition with `[DynamoDbTable]` attribute, the code block should satisfy all of the following:
- Should NOT also contain `[DynamoDbEntity]` attribute on the same class
- Should NOT contain `: IDynamoDbEntity` in the class declaration

**Validates: Requirements 5.1, 5.2**

## Error Handling

### Build Verification

After cleanup, all example projects must compile successfully:

```bash
dotnet build examples/OperationSamples/OperationSamples.csproj
dotnet build examples/InvoiceManager/InvoiceManager.csproj
dotnet build examples/StoreLocator/StoreLocator.csproj
dotnet build examples/TransactionDemo/TransactionDemo.csproj
dotnet build examples/TodoList/TodoList.csproj
```

### Potential Issues

1. **Missing using statements** - After removing `: IDynamoDbEntity`, ensure `using Oproto.FluentDynamoDb.Storage;` is still present if other types from that namespace are used
2. **Code referencing removed methods** - Search for usages of `CreatePk()` and `CreateSk()` in Program.cs or other files and update to use generated key methods (e.g., `Order.Keys.Pk(orderId)`)
3. **Key prefix configuration** - Ensure `[PartitionKey]` and `[SortKey]` attributes have appropriate `Prefix` values configured so the generated `Keys.Pk()` and `Keys.Sk()` methods produce correctly formatted keys

## Testing Strategy

### Unit Testing

No unit tests required - this is a structural cleanup with no behavioral changes.

### Property-Based Testing

Property-based tests will verify the structural correctness of the cleanup:

**Testing Framework:** xUnit with FsCheck (already used in the project)

**Property Test 1: Example Entity Structural Correctness**
- Generate: List of all .cs files in example project entity folders
- Property: Each file's content should not contain the problematic patterns
- Implementation: Parse file content and check for absence of `[DynamoDbEntity]`, `: IDynamoDbEntity`, and `CreatePk`/`CreateSk` method signatures

**Property Test 2: Documentation Code Block Correctness**
- Generate: List of all .md files in docs folder
- Property: No code block with `[DynamoDbTable]` should also contain `[DynamoDbEntity]` or `: IDynamoDbEntity`
- Implementation: Parse markdown, extract code blocks, check for pattern violations

### Manual Verification

1. Build all example projects
2. Run existing tests to ensure no regressions
3. Review documentation for clarity on attribute usage
