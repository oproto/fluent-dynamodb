# Requirements Document

## Introduction

This feature enhances the FluentDynamoDb LINQ expression support with three focused improvements:

1. **Sensitive Data Redaction in Expression Logging**: Apply existing `[Sensitive]` attribute detection to LINQ expression logging to prevent sensitive values from appearing in logs
2. **Format String Support**: Add Format property to DynamoDbAttribute and apply formatting during LINQ expression value serialization (similar to existing format string expression support)
3. **Manual Encryption Helper**: Provide a way for developers to manually encrypt query parameters when needed (not automatic, since many operations like `>`, `<`, `begins_with` won't work with encrypted values)

Note: Generic builder refactoring and LINQ expression overloads are already complete (tasks 1-5 from original spec).

## Glossary

- **Builder**: A fluent interface class that constructs DynamoDB request objects (QueryRequestBuilder, ScanRequestBuilder, etc.)
- **Type Parameter**: A generic type argument specified in angle brackets (e.g., `<TEntity>`)
- **Fluent Chain**: A sequence of method calls where each method returns an object that supports further chaining
- **Terminal Method**: The final method in a fluent chain that executes the operation (e.g., ExecuteAsync, ToListAsync)
- **Request Builder**: Classes like QueryRequestBuilder, ScanRequestBuilder, GetItemRequestBuilder that build DynamoDB requests
- **Source Generator**: Code generation tool that creates table classes and mapping code from entity attributes
- **LINQ Expression**: Language Integrated Query expressions using lambda syntax (e.g., `x => x.Id == id`)
- **Expression Translation**: The process of converting C# lambda expressions to DynamoDB query syntax
- **Sensitive Attribute**: Marker indicating a property value should be redacted from logs
- **Encrypted Attribute**: Marker indicating a property should be encrypted at rest
- **Format String**: A string template with placeholders for dynamic values (e.g., `"PK = {0}"`)
- **DynamoDbAttribute**: Attribute that configures how a property maps to DynamoDB, including format specifications

## Requirements

### Requirement 1: Sensitive Data Redaction in LINQ Expression Logging

**User Story:** As a developer, I want properties marked with [Sensitive] to be redacted when logging LINQ expressions, so that sensitive data doesn't leak into logs.

#### Acceptance Criteria

1. WHEN ExpressionTranslator logs a LINQ expression that references a [Sensitive] property, THE Logging_System SHALL redact the property value with "[REDACTED]"
2. WHEN logging expression translation, THE Logging_System SHALL preserve property names but redact values for sensitive properties
3. WHEN logging DynamoDB parameters generated from expressions, THE Logging_System SHALL redact values for parameters derived from sensitive properties
4. WHEN an expression contains both sensitive and non-sensitive properties, THE Logging_System SHALL redact only the sensitive values
5. THE Logging_System SHALL use existing SecurityMetadata generated by the source generator to identify sensitive fields

### Requirement 2: Format String Support in DynamoDbAttribute

**User Story:** As a developer, I want format specifications from DynamoDbAttribute to apply when using LINQ expressions, so that formatting is consistent across all expression types.

#### Acceptance Criteria

1. WHEN a property has DynamoDbAttribute with a Format parameter, THE Expression_Translator SHALL apply the format when generating DynamoDB values
2. WHEN translating x => x.Timestamp == dateValue, THE Expression_Translator SHALL format dateValue according to the Timestamp property's DynamoDbAttribute format
3. WHEN a property uses a custom format string (e.g., "yyyy-MM-dd"), THE Expression_Translator SHALL apply it during value serialization
4. WHEN no format is specified, THE Expression_Translator SHALL use default serialization
5. THE Expression_Translator SHALL support the same format specifications as text-based format string expressions

### Requirement 3: Manual Encryption Helpers for Query Parameters

**User Story:** As a developer, I want to manually encrypt query parameters using the same ambient EncryptionContext pattern as Put/Get operations, so that I can query encrypted fields using LINQ expressions, format strings, or pre-encrypted variables without automatic encryption breaking non-equality operations.

#### Acceptance Criteria

1. WHEN calling table.Encrypt(value, fieldName) within a LINQ expression, THE Expression_Translator SHALL detect the method call and encrypt the value using IFieldEncryptor with ambient EncryptionContext.Current
2. WHEN calling table.Encrypt(value, fieldName) in a format string expression, THE System SHALL encrypt the value using ambient EncryptionContext.Current
3. WHEN calling table.Encrypt(value, fieldName) with WithValue, THE System SHALL encrypt the value using ambient EncryptionContext.Current
4. WHEN calling table.EncryptValue(value, fieldName) before a query, THE System SHALL encrypt the value using ambient EncryptionContext.Current and return it for use in any expression type
5. THE System SHALL use the same FieldEncryptionContext construction pattern as generated ToDynamoDb/FromDynamoDb code (ContextId from EncryptionContext.Current, default CacheTtlSeconds)
6. WHEN encryption is not available (no IFieldEncryptor configured), THE System SHALL throw a clear exception with guidance
7. THE System SHALL NOT automatically encrypt values for properties marked with [Encrypted] in LINQ expressions
8. THE Documentation SHALL explain when manual encryption is appropriate (equality comparisons only) and when it should be avoided (range queries, begins_with, etc.)
9. THE Documentation SHALL provide examples of table.Encrypt() in LINQ expressions, format strings, and WithValue, plus EncryptValue helper, all showing use of ambient EncryptionContext.Current

### ~~Requirements 4-26: Previously Completed or Out of Scope~~

The following requirements from the original spec are either already completed (generic builders, LINQ overloads) or are out of scope for this focused update (discriminators, comprehensive E2E testing, documentation overhaul). They have been removed to keep this spec focused on the three core improvements listed above.
